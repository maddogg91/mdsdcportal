<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
      <link rel="stylesheet" type="text/css" href="home.css">
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
    <title>My Projects</title>
           <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.bundle.js" crossorigin="anonymous"></script>
      
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
    <link rel="stylesheet" type="text/css" href="dashboard.css">
   
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://unicons.iconscout.com/release/v3.0.6/css/line.css">
    <link rel="stylesheet" type="text/css" href="card.css">
    
  </head>
  <body>
    <!-- NAV BAR For Logged in pages will be different, to include dashboard navigation -->
    <nav class="navbar navbar-expand-md">
    <div class="container-fluid mx-2">
      <div class="navbar-header">
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#toggle-navbar" aria-controls="toggle-navbar" aria-expanded="false" aria-label="Toggle navigation">
          <i class="uil-bars text-white"></i>
        </button>
        <a class="navbar-brand" href="#"><img class="logo" src="/images/MdgLogoAlpha.png"/></a>
      </div>
      <div class="collapse navbar-collapse" id="toggle-navbar">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
              Settings
            </a>
            <ul class="dropdown-menu" aria-labelledby="navbarDropdown">
              <li>
                <a class="dropdown-item" href="/customeraccount">My account</a>
              </li>
              <li><a class="dropdown-item" href="/inbox">My inbox</a>
              </li>
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item" href="/logout">Log out</a></li>
            </ul>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/inbox"><i class="uil-comments-alt"></i><span><%= notifications.length %></span></a>
          </li>
       
          <li class="nav-item">
            <a class="nav-link" href="#">
              <i data-show="show-side-navigation1" class="uil-bars show-side-btn"></i>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </nav>
    <aside class="sidebar position-fixed top-0 left-0 overflow-auto h-100 float-left" id="show-side-navigation1">
  <i class="uil-bars close-aside d-md-none d-lg-none" data-close="show-side-navigation1"></i>
  <div class="sidebar-header d-flex justify-content-center align-items-center px-3 py-4">
   <img
         class="rounded-pill img-fluid"
         width="65"
         onerror='src="https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_1280.png"' src="<%=user.avatar%>"
         alt="">
    <div class="ms-2">
      <h5 class="fs-6 mb-0">
        <a class="text-decoration-none" href="#"> <%=user.name%> </a>
      </h5>
      <p class="mt-1 mb-0"><%=user.usertype%></p>
    </div>
  </div>

  <div class="search position-relative text-center px-4 py-3 mt-2">
   <small style= "color: whitesmoke">Double click/tap menu items</small>
    <i class="fa fa-search position-absolute d-block fs-6"></i>
  </div>

  <ul class="categories list-unstyled">
    <li class="has-dropdown">
      <i class="uil-estate fa-fw"></i><a href="#"> Projects</a>
      <ul class="sidebar-dropdown list-unstyled">
        <li><a href="/request">Create a project</a></li>
        <li><a href="/manage">Manage projects</a></li>
      </ul>
    </li>
   
    <li class="has-dropdown">
      <i class="uil-setting"></i><a href="#"> Settings</a>
      <ul class="sidebar-dropdown list-unstyled">
        <li><a href="/customeraccount">Update Profile</a></li>
        <li><a href="/customerbilling">Payment Options</a></li>
      </ul>
    </li>
    <li class="">
      <i class="uil-envelope-download fa-fw"></i><a href="/inbox"> Mailbox</a>
    </li>
    <li class="">
      <i class="uil-emoji"></i><a href="/logout"> Logout</a>
    </li>
  </ul>
</aside>
    
      </div>
    </section>
    <div class="row row-cols-1 row-cols-md-auto">
    
<% if (projects.length == 0) { %>
  <script type="text/javascript">
    alert("No projects found.");
    alert("Please create a project, returning to dashboard");
    window.location.href = "/dashboard";
  </script>
  </script>
  <% } else { %>
<% for (var x in projects) { %>
    
   <div  class="col mb-4">
   <div class="card"  style= "background-color: transparent; border: none;">
 
  <div class="cardc">
    <% if (projects[x].type=='website') { %>
     <img src='https://cdn-icons-png.flaticon.com/512/1006/1006771.png' class="cdimg" alt="...">
    <% } else if (projects[x].type=='webapp') { %>
       <img src="https://icon-library.com/images/web-application-icon/web-application-icon-13.jpg" class="cdimg" alt="...">
    <% } else if (projects[x].type=='mobile') { %>
      <img src="https://cdn-icons-png.flaticon.com/512/5608/5608615.png" class= "cdimg" alt="...">
    <% }  %>
   
    <h3><%= projects[x].request.businessname %></h3>
    
    <h4>Package Type: <%= projects[x].request.package%></h4></h4>
      <p><b>Project Details:</b> <br>Domain: <%= projects[x].request.website%> <br> Project Type: <%= projects[x].type%> <br> <small><b>Description: </b><%= projects[x].request.desc%></small> <br><small>Additional Info: <%= projects[x].request.type%> </small> </p><p style="color: green; font-weight: bolder;"> Project Balance: $<%= projects[x].balance %> </p> <button id="balance<%= projects[x].request.website%>" disabled class="btn btn-primary btn-sm" onclick="pay(<%= x%>)">Pay Now</button>
        <button onclick="purchase(<%= x %>)" class="btn btn-light btn-sm">Purchase Updates</button><button onclick="updateReq(<%= x %>)" class="btn btn-light btn-sm">Request An Update</button>
        <small style="color: blue; font-weight: bolder">Lifetime Updates: <%= projects[x].request.updates%></small> 
     <br>   <small>Request Date: <%= projects[x].creationdate%></small></small>
 
  
    <div class="w3-dark-grey w3-round-small">
    <div class="w3-container w3-blue w3-round-small" id="status<%= projects[x].request.website%>" style="width:25%">Status: <%= projects[x].status%></div>
  </div>
      
        <button  onclick="openForm(<%= x %>)" class="btn btn-light btn-sm">View Full Details</button>
        
        <button onclick="deleteProj(<%= x %>)" class="btn btn-light btn-sm">Delete</button>
      </div>
      </div>
   
        </div>

       
<% } %>
  <% } %>
</div>
  <div class="form-popup" id="myForm">
  <form class="form-container">
    <h4>Project Full Details</h4>

    <label for="project"><b>Project Name: <h6 id="pn">Undefined</h6></b></label>
    <input id="newpn" type="text" placeholder="Enter new domain name" name="website" required>

    <label for="pages"><b>Current Page Count: <h6 id="count">0</h6></b></label>
    <br>
    <small>Each Additional page are $50 per page. 5 pages is the max that can be requested at a time. </small>
    <select id="pages" name="pages">
      <option value="0">0</option>
      <option value="1">1</option>
      <option value="2">2</option>
      <option value="3">3</option>
      <option value="4">4</option>
      <option value="5">5</option>
    </select>

    <button type="button" class="btn" onclick="updateProj()">Update</button>
    <button type="button" class="btn cancel" onclick="closeForm()">Close</button>
  </form>
</div>
    <script>
      // Other important pens.
// Map: https://codepen.io/themustafaomar/pen/ZEGJeZq
// Navbar: https://codepen.io/themustafaomar/pen/VKbQyZ

'use strict'
var a= '<%= user%>';
var projects= JSON.parse(<%-JSON.stringify(data)%>);
var selectedProj= projects[0];
var opn= false;


      
projects.forEach(change);

function change(item){
    if(item.balance > 0){
      document.getElementById("balance"+item.request.website).disabled= false;

    }
   switch (item.request.package){
    case "1": 
      item.request.package= "Basic Package" 
      break; 
    case "2": 
      item.request.package= "Plus Package" 
      break; 
    case "3": 
      item.request.package= "Premium Package" 
      break; 
    }  

  switch (item.status){
    case "initiate":
        document.getElementById("status"+item.request.website).style.width= "25%"
        break;
    case "inprogress":
        document.getElementById("status"+item.request.website).style.width= "50%"
        break;
    case "review":
        document.getElementById("status"+item.request.website).style.width= "75%"
        break;
    case "updating":
        document.getElementById("status"+item.request.website).style.width= "90%"
        break;
    case "complete":
        document.getElementById("status"+item.request.website).style.width= "100%"
        document.getElementById("status"+item.request.website).class= "w3-container w3-green w3-round-small"
        break;
  }
}      


      function openForm(x) {
        selectedProj= projects[x];
        document.getElementById("pn").innerHTML= projects[x].request.website;
       document.getElementById("count").innerHTML= projects[x].request.pagecount;
        document.getElementById("myForm").style.display = "block";
      }

      function closeForm() {
        document.getElementById("myForm").style.display = "none";
      }
      function purchase(x){
        if(projects[x].request.updates > 6){
          alert("You have " + projects[x].request.updates + " updates remaining, please use those before requesting to purchase an update.");
          return null;
        }
        var y= confirm("Are you sure you want to purchase an update? Updates are $20+tax");
        if(y){
          alert("Purchase complete");
          projects[x].request.updates+=1;
          postrequest(projects[x]);
           window.location.reload();
        
        }
      }
      function updateReq(x) {

        var y= confirm("Are you sure you want to request an update? This will use one of your updates");
        if(y){
          let answer= prompt("Briefly describe what updates you will need below");
          if (answer == null || answer == "") {
            return;
          }
          projects[x].request.updates-=1;
          alert("Request Update Sent! Please allow 24-48 Hours for a response");
          updaterequest(projects[x], answer);
          postrequest(projects[x]);
           window.location.reload();
          
        }
      }

      function pay(x){
        let y= projects[x];
        let options = {
            method: 'POST',
            headers: {
                "Content-type": "application/json; charset=UTF-8",
              'Access-Control-Allow-Origin': '*'
            },
            body: JSON.stringify(y)
        }
          const promise = fetch('/customerPay', options);
        promise.then(response => {
            if(!response.ok){
                console.error(response)
            } 
         
          return response.text();
        }).then(result => {

          const win= window.open(
          result, "_blank");

          const timer = setInterval(() => {

          if(win.closed){
          clearInterval(timer);
            alert("Reloading page");
           location.reload(); 
          }
        })
        }, 500);
      }

      function updateProj() {
        var count= parseInt(document.getElementById("pages").value);
        var newname= document.getElementById("newpn").value;

        var newTotal= 50 * count;
        selectedProj.request.pagecount+= count;
        selectedProj.request.total+= newTotal;
        selectedProj.balance+= newTotal;
        if(newname!= ""){
          selectedProj.request.website= newname;
          
        }
       postrequest(selectedProj);
       window.location.reload();
      }

      function updaterequest(req, upd) {
        let data= {
          request: req,
          update: upd
        }
        let options = {
              method: 'POST',
              headers: {
                  "Content-type": "application/json; charset=UTF-8"
              },
              body: JSON.stringify(data)
          }
            const promise = fetch('/notifyupdate', options);
          promise.then(response => {
              if(!response.ok){
                  console.error(response)
              } 
          }).then(result => {
             window.location.reload();
            return false;

          })

      }

      function postrequest(req){
        let options = {
            method: 'POST',
            headers: {
                "Content-type": "application/json; charset=UTF-8"
            },
            body: JSON.stringify(req)
        }
          const promise = fetch('/update', options);
        promise.then(response => {
            if(!response.ok){
                console.error(response)
            } 
        }).then(result => {
         
          console.log("refres")
        })
      
      }

      function deleteProj(x){
        var y= confirm("Are you sure you want to delete this project from the system? You will no longer be able to track your progress, this does not remove current produced websites"+
                      " but will not allow you to request updates in the future.");
        if(y){
          
          let options = {
              method: 'POST',
              headers: {
                  "Content-type": "application/json; charset=UTF-8"
              },
              body: JSON.stringify(projects[x])
          }
    
          const promise = fetch('/deleteproject', options);
          promise.then(response => {
              if(!response.ok){
                  console.error(response)
              } 
          }).then(result => {
             window.location.reload();
            return false;

          })
      }
      }
      function refresh() {    
          setTimeout(function () {
              location.reload()
          }, 100);
      }
    </script>
    <script type="text/javascript" src= "selector.js">
       </script>
  </body>
</html>